<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Plataforma de Inspección Visual - Grupo Azor (Webcam Ajustada)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        :root {
            --azor-blue: #007bff; 
            --azor-blue-dark: #0056b3; 
            --light-bg: #f0f0f0; 
            --surface-bg: #ffffff; 
            --text-primary: #333333; 
            --text-secondary: #555555; 
            --border-color: #dddddd; 
            --success-color: #28a745;
            --error-color: #dc3545;
            --neutral-accent-color: #6c757d; 
            --border-radius: 8px; 
            --font-main: 'Roboto', sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body { 
            height: 100%;
            overflow: hidden; 
        }

        body {
            font-family: var(--font-main);
            background-color: var(--light-bg);
            color: var(--text-primary);
            line-height: 1.5; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            flex-direction: column;
        }

        .app-container {
            width: 95%;
            max-width: 1366px; 
            margin: 10px auto; 
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); 
            border-radius: var(--border-radius);
            overflow: hidden; 
            background-color: var(--surface-bg); 
        }

        .app-header {
            background-color: var(--azor-blue);
            color: white;
            padding: 10px 20px; 
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0; 
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo {
            max-height: 50px; /* Mantenido grande */
            margin-right: 15px; 
        }

        .app-header h1 {
            font-family: var(--font-main); 
            font-size: 1.6em; /* Mantenido grande */
            font-weight: 700;
        }

        .main-content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px; 
            padding: 15px; 
            background-color: var(--surface-bg);
            flex-grow: 1;
            overflow: hidden; 
        }

        .vision-panel, .controls-panel {
            background-color: var(--surface-bg);
            border: 1px solid var(--border-color);
            padding: 15px; 
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }
        
        .vision-panel h2, .controls-panel h3 { 
            font-family: var(--font-main);
            color: var(--azor-blue);
            margin-bottom: 10px; 
            padding-bottom: 6px; 
            border-bottom: 2px solid var(--azor-blue);
            font-size: 1.15em; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex; 
            align-items: center;
        }
        .vision-panel h2 i, .controls-panel h3 i { 
            margin-right: 8px;
        }

         .controls-panel h4 { 
            font-size: 0.9em; 
            color: var(--text-secondary);
            margin-bottom: 8px; 
            font-weight: 500;
        }

        #webcam-container {
            width: 700px;  /* CAMBIO: Ancho para webcam cuadrada más visible */
            height: 700px; /* CAMBIO: Alto para webcam cuadrada más visible */
            margin: 0 auto 10px auto; 
            border-radius: 6px; 
            overflow: hidden;
            background-color: #333; 
            border: 1px solid var(--border-color); 
            position: relative;
        }
        #webcam-container video,
        #webcam-container canvas { 
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }

        #progress-bar-container {
            width: 100%;
            height: 6px; 
            background-color: #e9ecef; 
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0; 
            display: block;
        }
        #progress-bar {
            height: 100%;
            width: 0;
            background-color: var(--success-color); 
            transition: width 0.4s ease-in-out;
            border-radius: 3px;
        }

        .label-container {
            font-size: 1.1em; 
            font-weight: bold;
            color: var(--text-primary);
            text-align: center;
            padding: 8px 10px; 
            background-color: #f8f9fa; 
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 8px; 
            min-height: 38px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .label-container span { 
            font-weight: bold;
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.85em; 
            text-align: center;
            padding: 6px 8px; 
            background-color: #f8d7da; 
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            margin-top: 8px; 
        }

        .controls-panel ol {
            font-size: 0.85rem; 
            line-height: 1.5; 
            color: var(--text-secondary);
            padding-left: 20px; 
            margin-bottom: 10px; 
        }
        .controls-panel ol li {
            margin-bottom: 5px; 
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px; 
            margin-bottom: 10px; 
        }

        .button {
            padding: 8px 15px; 
            font-size: 0.9rem; 
            font-weight: 500; 
            font-family: var(--font-main);
            border: 1px solid transparent; 
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease-in-out; 
            text-transform: none; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        .button i {
            font-size: 1em; 
        }

        .button.primary-action { 
            background-color: var(--azor-blue);
            color: white;
            border-color: var(--azor-blue-dark);
        }
        .button.primary-action:hover {
            background-color: var(--azor-blue-dark);
            transform: translateY(-1px); 
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
        }
        .button.primary-action:disabled {
            background-color: #a0c7e8;
            border-color: #8cb5d6;
            cursor: not-allowed;
        }

        .button.secondary-action { 
            background-color: var(--neutral-accent-color);
            color: white;
            border-color: #5a6268;
        }
        .button.secondary-action:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
        }

        #auditor-section {
            margin-top: auto; 
            text-align: center;
            padding-top: 10px; 
            border-top: 1px solid var(--border-color);
        }
        #auditor-image-container {
            display: inline-block; 
            position: relative; 
            margin-bottom: 6px; 
        }
        #auditor-image {
            max-width: 95px; 
            height: auto;
            border-radius: 50%;
            border: 3px solid var(--border-color); 
            transition: border-color 0.3s ease, transform 0.3s ease;
        }
        #auditor-image.status-ok { border-color: var(--success-color); transform: scale(1.05); }
        #auditor-image.status-error { border-color: var(--error-color); animation: auditorShake 0.5s; }
        #auditor-image.status-thinking {
            border-color: var(--azor-blue);
            animation: auditorPulse 1.2s infinite ease-in-out;
        }

        @keyframes auditorPulse { 
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 5px 5px rgba(0, 123, 255, 0.1); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.0); }
        }
        @keyframes auditorShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        #auditor-message-bubble {
            font-size: 0.9em; 
            color: var(--text-secondary);
            padding: 7px 10px; 
            background-color: #e9ecef;
            border-radius: 10px;
            border: 1px solid #ced4da;
            max-width: 210px; 
            margin: 0 auto; 
            min-height: 2.8em; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
         #auditor-title {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95em; 
            margin-bottom: 5px; 
         }

        .app-footer {
            background-color: #343a40; 
            color: #f8f9fa; 
            text-align: center;
            padding: 8px 15px; 
            font-size: 0.75rem; 
            flex-shrink: 0; 
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content-grid {
                grid-template-columns: 1.5fr 1fr; 
            }
        }
        @media (max-width: 992px) {
            .main-content-grid {
                grid-template-columns: 1fr; 
            }
            .app-header h1 { font-size: 1.3em; }
            .vision-panel h2, .controls-panel h3 { font-size: 1.1em; }
            #webcam-container { width: 200px; height: 200px; } /* Ajuste para tabletas */
        }
        @media (max-width: 768px) {
            .app-header { flex-direction: column; gap: 5px; padding: 10px; }
            .app-header h1 { font-size: 1.2em; text-align: center; }
            .logo { max-height: 35px; }
            .main-content-grid { padding: 10px; gap: 10px; }
            .vision-panel, .controls-panel { padding: 10px; }
            .button { padding: 7px 12px; font-size: 0.85rem; }
            .label-container { font-size: 1em; }
            #webcam-container { width: 180px; height: 180px; } /* Aún más pequeño en móviles */
            #auditor-image { max-width: 80px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo-container">
                <img src="Logo azor.png" alt="Logo Grupo Azor" class="logo">
                <h1>Control de Calidad Grupo Azor</h1>
            </div>
        </header>

        <main class="main-content-grid">
            <section class="vision-panel">
                <h2><i class="fas fa-eye"></i> Clasificador de Blister</h2>
                <div id="webcam-container">
                    </div>
                <div id="progress-bar-container" style="display:none;">
                    <div id="progress-bar"></div>
                </div>
                <div class="label-container" id="label-container">Iniciando sistema...</div>
                <div class="error-message" id="error-container" style="display: none;"></div>
            </section>

            <aside class="controls-panel">
                <h3><i class="fas fa-list-ol"></i> Instrucciones</h3>
                <h4>Instrucciones de Uso:</h4>
                <ol>
                    <li>Coloque el objeto a inspeccionar frente a la cámara.</li>
                    <li>Presione "Analizar Muestra" para iniciar la inspección.</li>
                    <li>El sistema identificará cualquier defecto o atributo visual.</li>
                </ol>

                <div class="action-buttons">
                    <button id="capture-button" class="button primary-action" disabled>
                        <i class="fas fa-camera-retro"></i> Cargar Modelo...
                    </button>
                    <button class="button secondary-action" onclick="window.location.href='https://web.azor.com.mx/';">
                        <i class="fas fa-home"></i> Volver al Inicio
                    </button>
                </div>

                <div id="auditor-section">
                    <p id="auditor-title">Asistente de Calidad IA</p>
                    <div id="auditor-image-container">
                        <img id="auditor-image" src="Auditor.png" alt="Asistente de Calidad IA">
                    </div>
                    <div id="auditor-message-bubble">Preparando sistema...</div>
                </div>
            </aside>
        </main>

        <footer class="app-footer">
            &copy; <span id="currentYear"></span> Grupo Azor México. Todos los derechos reservados.
        </footer>
    </div>

    <script type="text/javascript">
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        const URL = "./"; 
        let model, webcam, labelContainer, maxPredictions;
        const errorContainer = document.getElementById('error-container');
        const captureButton = document.getElementById('capture-button');
        const progressBar = document.getElementById('progress-bar');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const webcamContainer = document.getElementById('webcam-container');
        
        const auditorImage = document.getElementById('auditor-image');
        const auditorMessageBubble = document.getElementById('auditor-message-bubble');

        let isWebcamActive = false;
        let isAnalyzing = false; 

        function updateAuditor(status, message) {
            auditorMessageBubble.textContent = message;
            auditorImage.className = ''; 
            if (status === 'ok') {
                auditorImage.classList.add('status-ok');
            } else if (status === 'error') {
                auditorImage.classList.add('status-error');
            } else if (status === 'thinking' || status === 'loading') {
                auditorImage.classList.add('status-thinking');
            }
        }

        async function init() {
            labelContainer = document.getElementById("label-container");
            updateAuditor('loading', 'Cargando modelo de IA...');
            labelContainer.innerHTML = "Cargando modelo de IA...";
            progressBarContainer.style.display = 'block';
            captureButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando Modelo...';

            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            try {
                model = await tmImage.load(modelURL, metadataURL, (loaded, total) => {
                    if (total) {
                        let progress = (loaded / total) * 100;
                        progressBar.style.width = progress + '%';
                    }
                });
                maxPredictions = model.getTotalClasses();

                const flip = true;
                // CAMBIO: Usar dimensiones 220x220 para la webcam
                const webcamCanvasWidth = 220; 
                const webcamCanvasHeight = 220; 
                webcam = new tmImage.Webcam(webcamCanvasWidth, webcamCanvasHeight, flip); 
                await webcam.setup({ facingMode: "environment" }); 
                
                webcamContainer.innerHTML = ''; 
                webcamContainer.appendChild(webcam.canvas);
                
                await webcam.play();
                isWebcamActive = true;
                
                labelContainer.innerHTML = "Sistema listo. Presione 'Analizar Muestra'.";
                progressBarContainer.style.display = 'none';
                updateAuditor('idle', '¡Sistema listo! Coloque el blister y analice.');
                captureButton.disabled = false;
                captureButton.innerHTML = '<i class="fas fa-camera-retro"></i> Analizar Muestra';
                
            } catch (error) {
                console.error("Error al inicializar el sistema:", error);
                let errorMessageText = "Error al cargar el modelo. ";
                if (!navigator.onLine) {
                    errorMessageText += "Verifique su conexión a internet. ";
                }
                if (error.message.includes("fetch")) {
                     errorMessageText += "No se pudieron cargar los archivos del modelo. Verifique que 'model.json' y 'metadata.json' estén en la ubicación correcta. ";
                } else if (error.message.includes("getUserMedia")) {
                     errorMessageText += "No se pudo acceder a la cámara. Verifique los permisos. ";
                } else {
                    errorMessageText += "Detalles: " + error.message;
                }
                
                errorContainer.innerText = errorMessageText;
                errorContainer.style.display = 'block';
                labelContainer.innerHTML = "Error en la inicialización";
                labelContainer.style.color = 'var(--error-color)';
                progressBarContainer.style.display = 'none';
                captureButton.disabled = true;
                captureButton.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error al Cargar';
                updateAuditor('error', 'Error al iniciar. Revise la consola para detalles.');
            }
        }
        // ... (El resto del script JavaScript: loop, predict, toggleAnalysisState se mantiene igual funcionalmente) ...
        async function loop() {
            if (!isWebcamActive || !isAnalyzing) return; 
            
            webcam.update(); 
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            if (!model || !webcam || !webcam.canvas) {
                console.warn("Predicción omitida: modelo o webcam no disponibles.");
                return;
            }
            try {
                const prediction = await model.predict(webcam.canvas);
                let bestPrediction = prediction.reduce((max, p) => p.probability > max.probability ? p : max, prediction[0]);

                if (bestPrediction) {
                    const resultText = `${bestPrediction.className.toUpperCase()}`;
                    const isCorrect = bestPrediction.className.toLowerCase().includes('correcto'); 
                    const color = isCorrect ? 'var(--success-color)' : 'var(--error-color)';
                    
                    labelContainer.innerHTML = `Resultado: <span style="color: ${color}">${resultText}</span>`;

                    if(isCorrect) {
                        updateAuditor('ok', '¡Blister aprobado!'); 
                    } else {
                        updateAuditor('error', '¡Defecto detectado!'); 
                    }
                } else {
                    labelContainer.innerHTML = "No se pudo determinar el resultado.";
                    updateAuditor('idle', 'No estoy seguro del resultado.');
                }
            } catch (error) {
                console.error("Error durante la predicción:", error);
                errorContainer.innerText = "Error al procesar la imagen: " + error.message.substring(0,100); 
                errorContainer.style.display = 'block';
                labelContainer.innerHTML = "Error en predicción";
                updateAuditor('error', 'Problema al analizar la imagen.');
            }
        }

        function toggleAnalysisState() {
            if (!isWebcamActive) {
                 errorContainer.innerText = "El sistema de cámara no está activo. Intente recargar.";
                 errorContainer.style.display = 'block';
                 updateAuditor('error', 'Cámara no disponible.');
                 return;
            }

            isAnalyzing = !isAnalyzing;
            if (isAnalyzing) {
                captureButton.innerHTML = '<i class="fas fa-stop-circle"></i> Detener Análisis';
                errorContainer.style.display = 'none'; 
                labelContainer.innerHTML = "Analizando...";
                updateAuditor('thinking', 'Procesando imagen...');
                if (!webcam.playing) webcam.play(); 
                window.requestAnimationFrame(loop); 
            } else {
                captureButton.innerHTML = '<i class="fas fa-camera-retro"></i> Analizar Muestra';
                updateAuditor('idle', 'Análisis detenido. Listo para una nueva muestra.');
            }
        }
        captureButton.addEventListener('click', toggleAnalysisState);
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>